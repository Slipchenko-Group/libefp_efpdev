# LIBEFP

## Overview

The Effective Fragment Potential method (EFP) allows one to describe large
molecular systems by replacing chemically inert part of a system by a set of
Effective Fragments while performing regular ab initio calculation on the
chemically active part [1-8]. The libefp library is a full implementation of
the EFP2 method. It allows users to easily incorporate EFP2 support into their
favourite quantum chemistry package.


## EFPMD

The EFPMD program is a molecular simulation package based on LIBEFP. It allows
running EFP-only molecular simulations such as geometry optimization and
molecular dynamics. EFPMD is a part of this distribution. See README file in
the `efpmd` directory for more information.


## Installation

To build LIBEFP from source you need the following:

- C compiler (with C99 standard and OpenMP support)

- GNU make

If you are going to compile EFPMD you will need:

- BLAS library (CBLAS)

- Fortran 77 compiler

If you are going to run the test suite you will need:

- BLAS library (CBLAS)

- Check library (http://check.sourceforge.net/)

If you are using a checkout from source code repository you will need:

- GNU autoconf (version 2.62 or newer)

- GNU automake (version 1.11 or newer)

- GNU libtool (version 2.4.2 or newer)


To configure libefp issue the following command:

	./configure LIBS=CBLAS_LIBS --prefix=INSTALL_PATH

In the above command `INSTALL_PATH` is the path where the library will be
installed (e.g. `--prefix=/usr`) and `CBLAS_LIBS` are libraries providing CBLAS
implementation (e.g. `LIBS='-lcblas -lblas'`). For best parallel performance be
sure to use _SEQUENTIAL_ (i.e. not parallelized) BLAS implementation.

Alternatively if you only need the library you can run:

	./configure --disable-efpmd --prefix=INSTALL_PATH

To compile the library issue:

	make

To run the test suite (optional) issue:

	make check

Finally, install the library:

	make install


To compile the source code obtained directly form the source repository you
must have GNU autotools installed. You will need to generate configure script
first by running:

	./autogen.sh

After that proceed with compilation as usual.


## How to use the library

The description of the public API functions and structures provided by the
library is available at project's web site at http://www.libefp.org/.

To obtain an executable program link with provided shared (recommended) or
static libraries:

	gcc -o prog prog.c CBLAS_LIBS -lm -lefp

or

	gcc -o prog prog.c CBLAS_LIBS -lm libefp.a

In the above command `CBLAS_LIBS` are CBLAS libraries. You should substitute
`CBLAS_LIBS` with the command to link against the CBLAS library implementation
of your choice.


## How to create custom EFP fragment types

LIBEFP comes with a big library of ready-to-use fragments. If you will decide
to generate custom fragment parameters follow the instructions below.

LIBEFP uses EFP potential files in format generated by GAMESS quantum
chemistry package (see http://www.msg.ameslab.gov/gamess/). A version of GAMESS
from August 11, 2011 is the currently a recommended and tested version. A set
of pre-generated library fragments are available in the `fraglib` directory. If
you want to generate parameters for custom fragments you should create GAMESS
makefp job input similar to the `fraglib/makefp.inp` file. Using this input
file as a template you can create EFP parameters for arbitrary fragment types.

After you created `.efp` file using GAMESS you should rename the fragment by
replacing `$FRAGNAME` with your name of choice (e.g. rename `$FRAGNAME` to
`$MYH2O`). Also note that there is a bug in GAMESS which makes it print
excessive line continuation mark (which is a '>' sign) at the end of some
strings. For example if the number of elements in your 'FOCK MATRIX ELEMENTS'
section is divisible by four then GAMESS will print an unneeded '>' sing at the
end of last line. If parsing of your newly generated EFP potential fails with
syntax error then you probably have these extra marks somewhere. Check if
there are some extra line continuation marks in the last line of sections and
remove them for the parsing of a potential file to work.

For a complete description of EFP data file format consult FRAGNAME section in
GAMESS manual (see http://www.msg.ameslab.gov/gamess/).


## Information for code contributors

- The main design principle for the libefp library is Keep It Simple. All
  code should be easy to read and to understand. It should be easy to
  integrate the library into programs written in different programming
  languages. So the language of choice is C and no fancy OO hierarchies.

- Be consistent in coding style when adding new code. Consistency is more
  important than particular coding style. Use descriptive names for variables
  and functions. The bigger the scope of the symbol the longer its name should
  be. Look at the sources and maintain similar style for new code.

- As with most quantum chemistry methods EFP can require large amounts of
  memory. The guideline for developers here is simple: ALWAYS check for memory
  allocation errors in your code and return `EFP_RESULT_NO_MEMORY` on error.

- The code is reentrant which means that it is safe to use two different efp
  objects from two different threads. NEVER use mutable global state as it
  will break this. Store all mutable data in the efp object.

- Use `--enable-developer-flags` in configuration and make sure that
  compilation produces no warnings. Use `make check` to make sure that all new
  code passes the test cases.

- To debug using tests do `libtool --mode=execute gdb ./mytest` in tests
  directory. This will start `gdb` so you will be able to set breakpoints and
  inspect variables in your test program.


## References

1. Fragmentation Methods: A Route to Accurate Calculations on Large Systems.
   M.S.Gordon, D.G.Fedorov, S.R.Pruitt, L.V.Slipchenko. Chem. Rev. 112, 632-672
   (2012).

2. Effective fragment method for modeling intermolecular hydrogen bonding
   effects on quantum mechanical calculations. J.H.Jensen, P.N.Day, M.S.Gordon,
   H.Basch, D.Cohen, D.R.Garmer, M.Krauss, W.J.Stevens in "Modeling the
   Hydrogen Bond" (D.A. Smith, ed.) ACS Symposium Series 569, 1994, pp
   139-151.

3. An effective fragment method for modeling solvent effects in quantum
   mechanical calculations. P.N.Day, J.H.Jensen, M.S.Gordon, S.P.Webb,
   W.J.Stevens, M.Krauss, D.Garmer, H.Basch, D.Cohen. J.Chem.Phys. 105,
   1968-1986 (1996).

4. Solvation of the Menshutkin Reaction: A Rigorous test of the Effective
   Fragment Model. S.P.Webb, M.S.Gordon. J.Phys.Chem.A 103, 1265-73 (1999).

5. The Effective Fragment Potential Method: a QM-based MM approach to modeling
   environmental effects in chemistry. M.S.Gordon, M.A.Freitag,
   P.Bandyopadhyay, J.H.Jensen, V.Kairys, W.J.Stevens. J.Phys.Chem.A 105,
   293-307 (2001).

6. The Effective Fragment Potential: a general method for predicting
   intermolecular interactions. M.S.Gordon, L.V.Slipchenko, H.Li, J.H.Jensen.
   Annual Reports in Computational Chemistry, Volume 3, pp 177-193 (2007).

7. Water-benzene interactions: An effective fragment potential and correlated
   quantum chemistry study. L.V.Slipchenko, M.S.Gordon. J.Phys.Chem.A 113,
   2092-2102 (2009).

8. Damping functions in the effective fragment potential method. L.V.Slipchenko,
   M.S.Gordon. Mol.Phys. 107, 999-1016 (2009).
